/* esri-leaflet - v1.0.0 - 2015-07-10
*   Copyright (c) 2015 Environmental Systems Research Institute, Inc.
*   Apache License.
    Contains fixes by Hatfield Consultants 2015.
*/
(function(a){if(typeof define==="function"&&define.amd){define(["leaflet"],function(b){return a(b)})}else{if(typeof module==="object"&&typeof module.exports==="object"){module.exports=a(require("leaflet"))}}if(typeof window!=="undefined"&&window.L){a(window.L)}}(function(b){var a={VERSION:"1.0.0",Layers:{},Services:{},Controls:{},Tasks:{},Util:{},Support:{CORS:!!(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),pointerEvents:document.documentElement.style.pointerEvents===""}};if(typeof window!=="undefined"&&window.L){window.L.esri=a}(function(i){var m=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(p){return window.setTimeout(p,1000/60)};function d(q){var r={};for(var p in q){if(q.hasOwnProperty(p)){r[p]=q[p]}}return r}function l(p,q){for(var r=0;r<p.length;r++){if(p[r]!==q[r]){return false}}return true}function e(p){if(!l(p[0],p[p.length-1])){p.push(p[0])}return p}function n(s){var u=0,p=0;var t=s.length;var q=s[p];var r;for(p;p<t-1;p++){r=s[p+1];u+=(r[0]-q[0])*(r[1]+q[1]);q=r}return(u>=0)}function o(p,q,r,s){var u=(s[0]-r[0])*(p[1]-r[1])-(s[1]-r[1])*(p[0]-r[0]);var x=(q[0]-p[0])*(p[1]-r[1])-(q[1]-p[1])*(p[0]-r[0]);var w=(s[1]-r[1])*(q[0]-p[0])-(s[0]-r[0])*(q[1]-p[1]);if(w!==0){var t=u/w;var v=x/w;if(0<=t&&t<=1&&0<=v&&v<=1){return true}}return false}function c(p,q){for(var r=0;r<p.length-1;r++){for(var s=0;s<q.length-1;s++){if(o(p[r],p[r+1],q[s],q[s+1])){return true}}}return false}function h(q,u){var p=false;for(var r=-1,t=q.length,s=t-1;++r<t;s=r){if(((q[r][1]<=u[1]&&u[1]<q[s][1])||(q[s][1]<=u[1]&&u[1]<q[r][1]))&&(u[0]<(q[s][0]-q[r][0])*(u[1]-q[r][1])/(q[s][1]-q[r][1])+q[r][0])){p=!p}}return p}function g(s,q){var r=c(s,q);var p=h(s,q[0]);if(!r&&p){return true}return false}function f(A){var v=[];var s=[];var C;var u;var q;for(var y=0;y<A.length;y++){var z=e(A[y].slice(0));if(z.length<4){continue}if(n(z)){var w=[z];v.push(w)}else{s.push(z)}}var B=[];while(s.length){q=s.pop();var p=false;for(C=v.length-1;C>=0;C--){u=v[C][0];if(g(u,q)){v[C].push(q);p=true;break}}if(!p){B.push(q)}}while(B.length){q=B.pop();var t=false;for(C=v.length-1;C>=0;C--){u=v[C][0];if(c(u,q)){v[C].push(q);t=true;break}}if(!t){v.push([q.reverse()])}}if(v.length===1){return{type:"Polygon",coordinates:v[0]}}else{return{type:"MultiPolygon",coordinates:v}}}function k(t){var s=[];var u=t.slice(0);var r=e(u.shift().slice(0));if(r.length>=4){if(!n(r)){r.reverse()}s.push(r);for(var q=0;q<u.length;q++){var p=e(u[q].slice(0));if(p.length>=4){if(n(p)){p.reverse()}s.push(p)}}}return s}function j(t){var q=[];for(var p=0;p<t.length;p++){var r=k(t[p]);for(var u=r.length-1;u>=0;u--){var s=r[u].slice(0);q.push(s)}}return q}i.Util.extentToBounds=function(p){var r=new b.LatLng(p.ymin,p.xmin);var q=new b.LatLng(p.ymax,p.xmax);return new b.LatLngBounds(r,q)};i.Util.boundsToExtent=function(p){p=b.latLngBounds(p);return{xmin:p.getSouthWest().lng,ymin:p.getSouthWest().lat,xmax:p.getNorthEast().lng,ymax:p.getNorthEast().lat,spatialReference:{wkid:4326}}};i.Util.arcgisToGeojson=function(p,r){var q={};if(typeof p.x==="number"&&typeof p.y==="number"){q.type="Point";q.coordinates=[p.x,p.y]}if(p.points){q.type="MultiPoint";q.coordinates=p.points.slice(0)}if(p.paths){if(p.paths.length===1){q.type="LineString";q.coordinates=p.paths[0].slice(0)}else{q.type="MultiLineString";q.coordinates=p.paths.slice(0)}}if(p.rings){q=f(p.rings.slice(0))}if(p.geometry||p.attributes){q.type="Feature";q.geometry=(p.geometry)?i.Util.arcgisToGeojson(p.geometry):null;q.properties=(p.attributes)?d(p.attributes):null;if(p.attributes){q.id=p.attributes[r]||p.attributes.OBJECTID||p.attributes.FID}}return q};i.Util.geojsonToArcGIS=function(p,r){r=r||"OBJECTID";var t={wkid:4326};var s={};var q;switch(p.type){case"Point":s.x=p.coordinates[0];s.y=p.coordinates[1];s.spatialReference=t;break;case"MultiPoint":s.points=p.coordinates.slice(0);s.spatialReference=t;break;case"LineString":s.paths=[p.coordinates.slice(0)];s.spatialReference=t;break;case"MultiLineString":s.paths=p.coordinates.slice(0);s.spatialReference=t;break;case"Polygon":s.rings=k(p.coordinates.slice(0));s.spatialReference=t;break;case"MultiPolygon":s.rings=j(p.coordinates.slice(0));s.spatialReference=t;break;case"Feature":if(p.geometry){s.geometry=i.Util.geojsonToArcGIS(p.geometry,r)}s.attributes=(p.properties)?d(p.properties):{};if(p.id){s.attributes[r]=p.id}break;case"FeatureCollection":s=[];for(q=0;q<p.features.length;q++){s.push(i.Util.geojsonToArcGIS(p.features[q],r))}break;case"GeometryCollection":s=[];for(q=0;q<p.geometries.length;q++){s.push(i.Util.geojsonToArcGIS(p.geometries[q],r))}break}return s};i.Util.responseToFeatureCollection=function(v,s){var u;if(s){u=s}else{if(v.objectIdFieldName){u=v.objectIdFieldName}else{if(v.fields){for(var t=0;t<=v.fields.length-1;t++){if(v.fields[t].type==="esriFieldTypeOID"){u=v.fields[t].name;break}}}else{u="OBJECTID"}}}var p={type:"FeatureCollection",features:[]};var q=v.features||v.results;if(q.length){for(var r=q.length-1;r>=0;r--){p.features.push(i.Util.arcgisToGeojson(q[r],u))}}return p};i.Util.cleanUrl=function(p){p=p.replace(/^\s+|\s+$|\A\s+|\s+\z/g,"");if(p[p.length-1]!=="/"){p+="/"}return p};i.Util.isArcgisOnline=function(p){return(/\.arcgis\.com.*?FeatureServer/g).test(p)};i.Util.geojsonTypeToArcGIS=function(q){var p;switch(q){case"Point":p="esriGeometryPoint";break;case"MultiPoint":p="esriGeometryMultipoint";break;case"LineString":p="esriGeometryPolyline";break;case"MultiLineString":p="esriGeometryPolyline";break;case"Polygon":p="esriGeometryPolygon";break;case"MultiPolygon":p="esriGeometryPolygon";break}return p};i.Util.requestAnimationFrame=b.Util.bind(m,window);i.Util.warn=function(p){if(console&&console.warn){console.warn(p)}}})(a);(function(e){var c=0;window._EsriLeafletCallbacks={};function f(j){var g="";j.f=j.f||"json";for(var h in j){if(j.hasOwnProperty(h)){var i=j[h];var k=Object.prototype.toString.call(i);var l;if(g.length){g+="&"}if(k==="[object Array]"){l=(Object.prototype.toString.call(i[0])==="[object Object]")?JSON.stringify(i):i.join(",")}else{if(k==="[object Object]"){l=JSON.stringify(i)}else{if(k==="[object Date]"){l=i.valueOf()}else{l=i}}}g+=encodeURIComponent(h)+"="+encodeURIComponent(l)}}return g}function d(g,h){var i=new XMLHttpRequest();i.onerror=function(j){i.onreadystatechange=b.Util.falseFn;g.call(h,{error:{code:500,message:"XMLHttpRequest error"}},null)};i.onreadystatechange=function(){var l;var k;if(i.readyState===4){try{l=JSON.parse(i.responseText)}catch(j){l=null;k={code:500,message:"Could not parse response as JSON. This could also be caused by a CORS or XMLHttpRequest error."}}if(!k&&l.error){k=l.error;l=null}i.onerror=b.Util.falseFn;g.call(h,k,l)}};return i}e.Request={request:function(m,j,g,h){var k=f(j);var i=d(g,h);var l=(m+"?"+k).length;if(l<=2000&&b.esri.Support.CORS){i.open("GET",m+"?"+k);i.send(null)}else{if(l>2000&&b.esri.Support.CORS){i.open("POST",m);i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");i.send(k)}else{if(l<=2000&&!b.esri.Support.CORS){return b.esri.Request.get.JSONP(m,j,g,h)}else{e.Util.warn("a request to "+m+" was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html");return}}}return i},post:{XMLHTTP:function(k,j,g,h){var i=d(g,h);i.open("POST",k);i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");i.send(f(j));return i}},get:{CORS:function(k,j,g,h){var i=d(g,h);i.open("GET",k+"?"+f(j),true);i.send(null);return i},JSONP:function(l,j,g,i){var h="c"+c;j.callback="window._EsriLeafletCallbacks."+h;var k=b.DomUtil.create("script",null,document.body);k.type="text/javascript";k.src=l+"?"+f(j);k.id=h;window._EsriLeafletCallbacks[h]=function(n){if(window._EsriLeafletCallbacks[h]!==true){var m;var o=Object.prototype.toString.call(n);if(!(o==="[object Object]"||o==="[object Array]")){m={error:{code:500,message:"Expected array or object as JSONP response"}};n=null}if(!m&&n.error){m=n;n=null}g.call(i,m,n);window._EsriLeafletCallbacks[h]=true}};c++;return{id:h,url:k.src,abort:function(){window._EsriLeafletCallbacks._callback[h]({code:0,message:"Request aborted."})}}}}};e.get=(e.Support.CORS)?e.Request.get.CORS:e.Request.get.JSONP;e.post=e.Request.post.XMLHTTP;e.request=e.Request.request})(a);a.Services.Service=b.Class.extend({includes:b.Mixin.Events,options:{proxy:false,useCors:a.Support.CORS},initialize:function(c){c=c||{};this._requestQueue=[];this._authenticating=false;b.Util.setOptions(this,c);this.options.url=a.Util.cleanUrl(this.options.url)},get:function(f,e,c,d){return this._request("get",f,e,c,d)},post:function(f,e,c,d){return this._request("post",f,e,c,d)},request:function(f,e,c,d){return this._request("request",f,e,c,d)},metadata:function(c,d){return this._request("get","",{},c,d)},authenticate:function(c){this._authenticating=false;this.options.token=c;this._runQueue();return this},_request:function(e,g,f,c,d){this.fire("requeststart",{url:this.options.url+g,params:f,method:e});var i=this._createServiceCallback(e,g,f,c,d);if(this.options.token){f.token=this.options.token}if(this._authenticating){this._requestQueue.push([e,g,f,c,d]);return}else{var h=(this.options.proxy)?this.options.proxy+"?"+this.options.url+g:this.options.url+g;if(this.options.subdomains&&this.options.subdomains.length){h=b.Util.template(h,b.extend({s:this.options.subdomains[0]},this.options))}if((e==="get"||e==="request")&&!this.options.useCors){return a.Request.get.JSONP(h,f,i)}else{return a[e](h,f,i)}}},_createServiceCallback:function(e,g,f,c,d){return b.Util.bind(function(h,i){if(h&&(h.code===499||h.code===498)){this._authenticating=true;this._requestQueue.push([e,g,f,c,d]);this.fire("authenticationrequired",{authenticate:b.Util.bind(this.authenticate,this)});h.authenticate=b.Util.bind(this.authenticate,this)}c.call(d,h,i);if(h){this.fire("requesterror",{url:this.options.url+g,params:f,message:h.message,code:h.code,method:e})}else{this.fire("requestsuccess",{url:this.options.url+g,params:f,response:i,method:e})}this.fire("requestend",{url:this.options.url+g,params:f,method:e})},this)},_runQueue:function(){for(var c=this._requestQueue.length-1;c>=0;c--){var e=this._requestQueue[c];var d=e.shift();this[d].apply(this,e)}this._requestQueue=[]}});a.Services.service=function(c){return new a.Services.Service(c)};a.Services.FeatureLayerService=a.Services.Service.extend({options:{idAttribute:"OBJECTID"},query:function(){return new a.Tasks.Query(this)},addFeature:function(e,c,d){delete e.id;e=a.Util.geojsonToArcGIS(e);return this.post("addFeatures",{features:[e]},function(f,g){var h=(g&&g.addResults)?g.addResults[0]:undefined;if(c){c.call(d,f||g.addResults[0].error,h)}},d)},updateFeature:function(e,c,d){e=a.Util.geojsonToArcGIS(e,this.options.idAttribute);return this.post("updateFeatures",{features:[e]},function(f,g){var h=(g&&g.updateResults)?g.updateResults[0]:undefined;if(c){c.call(d,f||g.updateResults[0].error,h)}},d)},deleteFeature:function(e,c,d){return this.post("deleteFeatures",{objectIds:e},function(f,g){var h=(g&&g.deleteResults)?g.deleteResults[0]:undefined;if(c){c.call(d,f||g.deleteResults[0].error,h)}},d)},deleteFeatures:function(e,c,d){return this.post("deleteFeatures",{objectIds:e},function(f,g){var h=(g&&g.deleteResults)?g.deleteResults:undefined;if(c){c.call(d,f||g.deleteResults[0].error,h)}},d)}});a.Services.featureLayerService=function(c){return new a.Services.FeatureLayerService(c)};a.Services.MapService=a.Services.Service.extend({identify:function(){return new a.Tasks.identifyFeatures(this)},find:function(){return new a.Tasks.Find(this)},query:function(){return new a.Tasks.Query(this)}});a.Services.mapService=function(c){return new a.Services.MapService(c)};a.Services.ImageService=a.Services.Service.extend({query:function(){return new a.Tasks.Query(this)},identify:function(){return new a.Tasks.IdentifyImage(this)}});a.Services.imageService=function(c){return new a.Services.ImageService(c)};a.Tasks.Task=b.Class.extend({options:{proxy:false,useCors:a.Support.CORS},generateSetter:function(d,c){return b.Util.bind(function(e){this.params[d]=e;return this},c)},initialize:function(c){if(c.request&&c.options){this._service=c;b.Util.setOptions(this,c.options)}else{b.Util.setOptions(this,c);this.options.url=b.esri.Util.cleanUrl(c.url)}this.params=b.Util.extend({},this.params||{});if(this.setters){for(var e in this.setters){var d=this.setters[e];this[e]=this.generateSetter(d,this)}}},token:function(c){if(this._service){this._service.authenticate(c)}else{this.params.token=c}return this},request:function(c,d){if(this._service){return this._service.request(this.path,this.params,c,d)}else{return this._request("request",this.path,this.params,c,d)}},_request:function(e,g,f,c,d){var h=(this.options.proxy)?this.options.proxy+"?"+this.options.url+g:this.options.url+g;if((e==="get"||e==="request")&&!this.options.useCors){return a.Request.get.JSONP(h,f,c,d)}else{return a[e](h,f,c,d)}}});a.Tasks.Query=a.Tasks.Task.extend({setters:{offset:"offset",limit:"limit",fields:"outFields",precision:"geometryPrecision",featureIds:"objectIds",returnGeometry:"returnGeometry",token:"token"},path:"query",params:{returnGeometry:true,where:"1=1",outSr:4326,outFields:"*"},within:function(c){this._setGeometry(c);this.params.spatialRel="esriSpatialRelContains";return this},intersects:function(c){this._setGeometry(c);this.params.spatialRel="esriSpatialRelIntersects";return this},contains:function(c){this._setGeometry(c);this.params.spatialRel="esriSpatialRelWithin";return this},overlaps:function(c){this._setGeometry(c);this.params.spatialRel="esriSpatialRelOverlaps";return this},nearby:function(c,d){c=b.latLng(c);this.params.geometry=[c.lng,c.lat];this.params.geometryType="esriGeometryPoint";this.params.spatialRel="esriSpatialRelIntersects";this.params.units="esriSRUnit_Meter";this.params.distance=d;this.params.inSr=4326;return this},where:function(c){this.params.where=c;return this},between:function(d,c){this.params.time=[d.valueOf(),c.valueOf()];return this},simplify:function(d,c){var e=Math.abs(d.getBounds().getWest()-d.getBounds().getEast());this.params.maxAllowableOffset=(e/d.getSize().y)*c;return this},orderBy:function(c,d){d=d||"ASC";this.params.orderByFields=(this.params.orderByFields)?this.params.orderByFields+",":"";this.params.orderByFields+=([c,d]).join(" ");return this},run:function(c,d){this._cleanParams();if(a.Util.isArcgisOnline(this.options.url)){this.params.f="geojson";return this.request(function(e,f){this._trapSQLerrors(e);c.call(d,e,f,f)},this)}else{return this.request(function(e,f){this._trapSQLerrors(e);c.call(d,e,(f&&a.Util.responseToFeatureCollection(f)),f)},this)}},count:function(c,d){this._cleanParams();this.params.returnCountOnly=true;return this.request(function(e,f){c.call(this,e,(f&&f.count),f)},d)},ids:function(c,d){this._cleanParams();this.params.returnIdsOnly=true;return this.request(function(e,f){c.call(this,e,(f&&f.objectIds),f)},d)},bounds:function(c,d){this._cleanParams();this.params.returnExtentOnly=true;return this.request(function(e,f){c.call(d,e,(f&&f.extent&&a.Util.extentToBounds(f.extent)),f)},d)},pixelSize:function(c){c=b.point(c);this.params.pixelSize=[c.x,c.y];return this},layer:function(c){this.path=c+"/query";return this},_trapSQLerrors:function(c){if(c){if(c.code==="400"){a.Util.warn("one common syntax error in query requests is encasing string values in double quotes instead of single quotes")}}},_cleanParams:function(){delete this.params.returnIdsOnly;delete this.params.returnExtentOnly;delete this.params.returnCountOnly},_setGeometry:function(c){this.params.inSr=4326;if(c instanceof b.LatLngBounds){this.params.geometry=a.Util.boundsToExtent(c);this.params.geometryType="esriGeometryEnvelope";return}if(c.getLatLng){c=c.getLatLng()}if(c instanceof b.LatLng){c={type:"Point",coordinates:[c.lng,c.lat]}}if(c instanceof b.GeoJSON){c=c.getLayers()[0].feature.geometry;this.params.geometry=a.Util.geojsonToArcGIS(c);this.params.geometryType=a.Util.geojsonTypeToArcGIS(c.type)}if(c.toGeoJSON){c=c.toGeoJSON()}if(c.type==="Feature"){c=c.geometry}if(c.type==="Point"||c.type==="LineString"||c.type==="Polygon"){this.params.geometry=a.Util.geojsonToArcGIS(c);this.params.geometryType=a.Util.geojsonTypeToArcGIS(c.type);return}a.Util.warn("invalid geometry passed to spatial query. Should be an L.LatLng, L.LatLngBounds or L.Marker or a GeoJSON Point Line or Polygon object");return}});a.Tasks.query=function(c){return new a.Tasks.Query(c)};a.Tasks.Find=a.Tasks.Task.extend({setters:{contains:"contains",text:"searchText",fields:"searchFields",spatialReference:"sr",sr:"sr",layers:"layers",returnGeometry:"returnGeometry",maxAllowableOffset:"maxAllowableOffset",precision:"geometryPrecision",dynamicLayers:"dynamicLayers",returnZ:"returnZ",returnM:"returnM",gdbVersion:"gdbVersion",token:"token"},path:"find",params:{sr:4326,contains:true,returnGeometry:true,returnZ:true,returnM:false},layerDefs:function(c,d){this.params.layerDefs=(this.params.layerDefs)?this.params.layerDefs+";":"";this.params.layerDefs+=([c,d]).join(":");return this},simplify:function(d,c){var e=Math.abs(d.getBounds().getWest()-d.getBounds().getEast());this.params.maxAllowableOffset=(e/d.getSize().y)*c;return this},run:function(c,d){return this.request(function(e,f){c.call(d,e,(f&&a.Util.responseToFeatureCollection(f)),f)},d)}});a.Tasks.find=function(c){return new a.Tasks.Find(c)};a.Tasks.Identify=a.Tasks.Task.extend({path:"identify",between:function(d,c){this.params.time=[d.valueOf(),c.valueOf()];return this}});a.Tasks.IdentifyImage=a.Tasks.Identify.extend({setters:{setMosaicRule:"mosaicRule",setRenderingRule:"renderingRule",setPixelSize:"pixelSize",returnCatalogItems:"returnCatalogItems",returnGeometry:"returnGeometry"},params:{returnGeometry:false},at:function(c){c=b.latLng(c);this.params.geometry=JSON.stringify({x:c.lng,y:c.lat,spatialReference:{wkid:4326}});this.params.geometryType="esriGeometryPoint";return this},getMosaicRule:function(){return this.params.mosaicRule},getRenderingRule:function(){return this.params.renderingRule},getPixelSize:function(){return this.params.pixelSize},run:function(c,d){return this.request(function(e,f){c.call(d,e,(f&&this._responseToGeoJSON(f)),f)},this)},_responseToGeoJSON:function(h){var g=h.location;var c=h.catalogItems;var d=h.catalogItemVisibilities;var e={pixel:{type:"Feature",geometry:{type:"Point",coordinates:[g.x,g.y]},crs:{type:"EPSG",properties:{code:g.spatialReference.wkid}},properties:{OBJECTID:h.objectId,name:h.name,value:h.value},id:h.objectId}};if(h.properties&&h.properties.Values){e.pixel.properties.values=h.properties.Values}if(c&&c.features){e.catalogItems=a.Util.responseToFeatureCollection(c);if(d&&d.length===e.catalogItems.features.length){for(var f=d.length-1;f>=0;f--){e.catalogItems.features[f].properties.catalogItemVisibility=d[f]}}}return e}});a.Tasks.identifyImage=function(c){return new a.Tasks.IdentifyImage(c)};a.Tasks.IdentifyFeatures=a.Tasks.Identify.extend({setters:{layers:"layers",precision:"geometryPrecision",tolerance:"tolerance",returnGeometry:"returnGeometry"},params:{sr:4326,layers:"all",tolerance:3,returnGeometry:true},on:function(d){var c=a.Util.boundsToExtent(d.getBounds());var e=d.getSize();this.params.imageDisplay=[e.x,e.y,96];this.params.mapExtent=[c.xmin,c.ymin,c.xmax,c.ymax];return this},at:function(c){c=b.latLng(c);this.params.geometry=[c.lng,c.lat];this.params.geometryType="esriGeometryPoint";return this},layerDef:function(c,d){this.params.layerDefs=(this.params.layerDefs)?this.params.layerDefs+";":"";this.params.layerDefs+=([c,d]).join(":");return this},simplify:function(d,c){var e=Math.abs(d.getBounds().getWest()-d.getBounds().getEast());this.params.maxAllowableOffset=(e/d.getSize().y)*(1-c);return this},run:function(c,d){return this.request(function(e,j){if(e){c.call(d,e,undefined,j);return}else{var g=a.Util.responseToFeatureCollection(j);j.results=j.results.reverse();for(var h=0;h<g.features.length;h++){var f=g.features[h];f.layerId=j.results[h].layerId}c.call(d,undefined,g,j)}})}});a.Tasks.identifyFeatures=function(c){return new a.Tasks.IdentifyFeatures(c)};(function(c){var d=(window.location.protocol!=="https:")?"http:":"https:";c.Layers.BasemapLayer=b.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"https://static.arcgis.com/attribution/World_Street_Map",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"Esri"}},Topographic:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"https://static.arcgis.com/attribution/World_Topo_Map",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"Esri"}},Oceans:{urlTemplate:d+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}",attributionUrl:"https://static.arcgis.com/attribution/Ocean_Basemap",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri"}},OceansLabels:{urlTemplate:d+"//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:true,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"]}},NationalGeographic:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri"}},DarkGray:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri, DeLorme, HERE"}},DarkGrayLabels:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:true,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"]}},Gray:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"],attribution:"Esri, NAVTEQ, DeLorme"}},GrayLabels:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:true,logoPosition:"bottomright",minZoom:1,maxZoom:16,subdomains:["server","services"]}},Imagery:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"],attribution:"Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community"}},ImageryLabels:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:true,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"]}},ImageryTransportation:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:true,logoPosition:"bottomright",minZoom:1,maxZoom:19,subdomains:["server","services"]}},ShadedRelief:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"Esri, NAVTEQ, DeLorme"}},ShadedReliefLabels:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:true,logoPosition:"bottomright",minZoom:1,maxZoom:12,subdomains:["server","services"]}},Terrain:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:false,logoPosition:"bottomright",minZoom:1,maxZoom:13,subdomains:["server","services"],attribution:"Esri, USGS, NOAA"}},TerrainLabels:{urlTemplate:d+"//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}",options:{hideLogo:true,logoPosition:"bottomright",minZoom:1,maxZoom:13,subdomains:["server","services"]}}}},initialize:function(f,g){var e;if(typeof f==="object"&&f.urlTemplate&&f.options){e=f}else{if(typeof f==="string"&&c.BasemapLayer.TILES[f]){e=c.BasemapLayer.TILES[f]}else{throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of "Streets", "Topographic", "Oceans", "OceansLabels", "NationalGeographic", "Gray", "GrayLabels", "DarkGray", "DarkGrayLabels", "Imagery", "ImageryLabels", "ImageryTransportation", "ShadedRelief", "ShadedReliefLabels", "Terrain" or "TerrainLabels"')}}var h=b.Util.extend(e.options,g);b.TileLayer.prototype.initialize.call(this,e.urlTemplate,b.Util.setOptions(this,h));if(e.attributionUrl){this._getAttributionData(e.attributionUrl)}this._logo=new c.Controls.Logo({position:this.options.logoPosition})},onAdd:function(e){if(!this.options.hideLogo&&!e._hasEsriLogo){this._logo.addTo(e);e._hasEsriLogo=true}b.TileLayer.prototype.onAdd.call(this,e);e.on("moveend",this._updateMapAttribution,this)},onRemove:function(e){if(this._logo&&this._logo._container){e.removeControl(this._logo);e._hasEsriLogo=false}b.TileLayer.prototype.onRemove.call(this,e);e.off("moveend",this._updateMapAttribution,this)},getAttribution:function(){var e='<span class="esri-attributions" style="line-height:14px; vertical-align: -3px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; display:inline-block;">'+this.options.attribution+"</span>";return e},_getAttributionData:function(e){b.esri.Request.get.JSONP(e,{},b.Util.bind(function(k,f){this._attributions=[];for(var g=0;g<f.contributors.length;g++){var h=f.contributors[g];for(var l=0;l<h.coverageAreas.length;l++){var j=h.coverageAreas[l];var n=new b.LatLng(j.bbox[0],j.bbox[1]);var m=new b.LatLng(j.bbox[2],j.bbox[3]);this._attributions.push({attribution:h.attribution,score:j.score,bounds:new b.LatLngBounds(n,m),minZoom:j.zoomMin,maxZoom:j.zoomMax})}}this._attributions.sort(function(i,o){return o.score-i.score});this._updateMapAttribution()},this))},_updateMapAttribution:function(){if(this._map&&this._map.attributionControl&&this._attributions){var j="";var g=this._map.getBounds();var l=this._map.getZoom();for(var h=0;h<this._attributions.length;h++){var e=this._attributions[h];var k=e.attribution;if(!j.match(k)&&g.intersects(e.bounds)&&l>=e.minZoom&&l<=e.maxZoom){j+=(", "+k)}}j=j.substr(2);var f=this._map.attributionControl._container.querySelector(".esri-attributions");f.innerHTML=j;f.style.maxWidth=(this._map.getSize().x*0.65)+"px";this.fire("attributionupdated",{attribution:j})}}});c.BasemapLayer=c.Layers.BasemapLayer;c.Layers.basemapLayer=function(e,f){return new c.Layers.BasemapLayer(e,f)};c.basemapLayer=function(e,f){return new c.Layers.BasemapLayer(e,f)}})(a);a.Layers.RasterLayer=b.Class.extend({includes:b.Mixin.Events,options:{opacity:1,position:"front",f:"image",zIndex:null},setZIndex:function(c){this.options.zIndex=c;this._updateZIndex();return this},_updateZIndex:function(){if(this._currentImage&&this.options.zIndex!==undefined&&this.options.zIndex!==null){this._currentImage._image.style.zIndex=this.options.zIndex}},onAdd:function(c){this._map=c;this._update=b.Util.limitExecByInterval(this._update,this.options.updateInterval,this);if(c.options.crs&&c.options.crs.code){var d=c.options.crs.code.split(":")[1];this.options.bboxSR=d;this.options.imageSR=d}c.on("moveend",this._update,this);if(this._currentImage&&this._currentImage._bounds.equals(this._map.getBounds())){c.addLayer(this._currentImage)}else{if(this._currentImage){this._map.removeLayer(this._currentImage);this._currentImage=null}}this._update();if(this._popup){this._map.on("click",this._getPopupData,this);this._map.on("dblclick",this._resetPopupState,this)}},bindPopup:function(c,d){this._shouldRenderPopup=false;this._lastClick=false;this._popup=b.popup(d);this._popupFunction=c;if(this._map){this._map.on("click",this._getPopupData,this);this._map.on("dblclick",this._resetPopupState,this)}return this},unbindPopup:function(){if(this._map){this._map.closePopup(this._popup);this._map.off("click",this._getPopupData,this);this._map.off("dblclick",this._resetPopupState,this)}this._popup=false;return this},onRemove:function(c){if(this._currentImage){this._map.removeLayer(this._currentImage)}if(this._popup){this._map.off("click",this._getPopupData,this);this._map.off("dblclick",this._resetPopupState,this)}this._map.off("moveend",this._update,this);this._map=null},addTo:function(c){c.addLayer(this);return this},removeFrom:function(c){c.removeLayer(this);return this},bringToFront:function(){this.options.position="front";if(this._currentImage){this._currentImage.bringToFront()}return this},bringToBack:function(){this.options.position="back";if(this._currentImage){this._currentImage.bringToBack()}return this},getAttribution:function(){return this.options.attribution},getOpacity:function(){return this.options.opacity},setOpacity:function(c){this.options.opacity=c;this._currentImage.setOpacity(c);return this},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(c,d){this.options.from=c;this.options.to=d;this._update();return this},metadata:function(c,d){this._service.metadata(c,d);return this},authenticate:function(c){this._service.authenticate(c);return this},_renderImage:function(e,c){if(this._map){var d=new b.ImageOverlay(e,c,{opacity:0}).addTo(this._map);d.once("load",function(f){var g=f.target;var h=this._currentImage;if(g._bounds.equals(c)&&g._bounds.equals(this._map.getBounds())){this._currentImage=g;if(this.options.position==="front"){this.bringToFront()}else{this.bringToBack()}this._updateZIndex();if(this._map&&this._currentImage._map){this._currentImage.setOpacity(this.options.opacity)}else{this._currentImage._map.removeLayer(this._currentImage)}if(h&&this._map){this._map.removeLayer(h)}if(h&&h._map){h._map.removeLayer(h)}}else{this._map.removeLayer(g)}this.fire("load",{bounds:c})},this);this.fire("loading",{bounds:c})}},_update:function(){if(!this._map){return}var e=this._map.getZoom();var c=this._map.getBounds();if(this._animatingZoom){return}if(this._map._panTransition&&this._map._panTransition._inProgress){return}if(e>this.options.maxZoom||e<this.options.minZoom){return}var d=this._buildExportParams();this._requestExport(d,c)},_renderPopup:function(e,d,g,f){e=b.latLng(e);if(this._shouldRenderPopup&&this._lastClick.equals(e)){var c=this._popupFunction(d,g,f);if(c){this._popup.setLatLng(e).setContent(c).openOn(this._map)}}},_resetPopupState:function(c){this._shouldRenderPopup=false;this._lastClick=c.latlng},_propagateEvent:function(c){c=b.extend({layer:c.target,target:this},c);this.fire(c.type,c)}});a.Layers.DynamicMapLayer=a.Layers.RasterLayer.extend({options:{updateInterval:150,layers:false,layerDefs:false,timeOptions:false,format:"png24",transparent:true,f:"json"},initialize:function(c){c.url=a.Util.cleanUrl(c.url);this._service=new a.Services.MapService(c);this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this);if((c.proxy||c.token)&&c.f!=="json"){c.f="json"}b.Util.setOptions(this,c)},getDynamicLayers:function(){return this.options.dynamicLayers},setDynamicLayers:function(c){this.options.dynamicLayers=c;this._update();return this},getLayers:function(){return this.options.layers},setLayers:function(c){this.options.layers=c;this._update();return this},getLayerDefs:function(){return this.options.layerDefs},setLayerDefs:function(c){this.options.layerDefs=c;this._update();return this},getTimeOptions:function(){return this.options.timeOptions},setTimeOptions:function(c){this.options.timeOptions=c;this._update();return this},query:function(){return this._service.query()},identify:function(){return this._service.identify()},find:function(){return this._service.find()},_getPopupData:function(d){var c=b.Util.bind(function(e,g,h){if(e){return}setTimeout(b.Util.bind(function(){this._renderPopup(d.latlng,e,g,h)},this),300)},this);var f=this.identify().on(this._map).at(d.latlng);if(this.options.layers){f.layers("visible:"+this.options.layers.join(","))}else{f.layers("visible")}f.run(c);this._shouldRenderPopup=true;this._lastClick=d.latlng},_buildExportParams:function(){var d=this._map.getBounds();var g=this._map.getSize();var e=this._map.options.crs.project(d._northEast);var h=this._map.options.crs.project(d._southWest);var i=this._map.latLngToLayerPoint(d._northEast);var c=this._map.latLngToLayerPoint(d._southWest);if(i.y>0||c.y<g.y){g.y=c.y-i.y}var f={bbox:[h.x,h.y,e.x,e.y].join(","),size:g.x+","+g.y,dpi:96,format:this.options.format,transparent:this.options.transparent,bboxSR:this.options.bboxSR,imageSR:this.options.imageSR};if(this.options.dynamicLayers){f.dynamicLayers=this.options.dynamicLayers}if(this.options.layers){f.layers="show:"+this.options.layers.join(",")}if(this.options.layerDefs){f.layerDefs=JSON.stringify(this.options.layerDefs)}if(this.options.timeOptions){f.timeOptions=JSON.stringify(this.options.timeOptions)}if(this.options.from&&this.options.to){f.time=this.options.from.valueOf()+","+this.options.to.valueOf()}if(this._service.options.token){f.token=this._service.options.token}return f},_requestExport:function(d,c){if(this.options.f==="json"){this._service.request("export",d,function(e,f){if(e){return}this._renderImage(f.href,c)},this)}else{d.f="image";this._renderImage(this.options.url+"export"+b.Util.getParamString(d),c)}}});a.DynamicMapLayer=a.Layers.DynamicMapLayer;a.Layers.dynamicMapLayer=function(c){return new a.Layers.DynamicMapLayer(c)};a.dynamicMapLayer=function(c){return new a.Layers.DynamicMapLayer(c)};a.Layers.ImageMapLayer=a.Layers.RasterLayer.extend({options:{updateInterval:150,format:"jpgpng",transparent:true,f:"json"},query:function(){return this._service.query()},identify:function(){return this._service.identify()},initialize:function(c){c.url=a.Util.cleanUrl(c.url);this._service=new a.Services.ImageService(c);this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this);b.Util.setOptions(this,c)},setPixelType:function(c){this.options.pixelType=c;this._update();return this},getPixelType:function(){return this.options.pixelType},setBandIds:function(c){if(b.Util.isArray(c)){this.options.bandIds=c.join(",")}else{this.options.bandIds=c.toString()}this._update();return this},getBandIds:function(){return this.options.bandIds},setNoData:function(c,d){if(b.Util.isArray(c)){this.options.noData=c.join(",")}else{this.options.noData=c.toString()}if(d){this.options.noDataInterpretation=d}this._update();return this},getNoData:function(){return this.options.noData},getNoDataInterpretation:function(){return this.options.noDataInterpretation},setRenderingRule:function(c){this.options.renderingRule=c;this._update()},getRenderingRule:function(){return this.options.renderingRule},setMosaicRule:function(c){this.options.mosaicRule=c;this._update()},getMosaicRule:function(){return this.options.mosaicRule},_getPopupData:function(d){var c=b.Util.bind(function(e,h,g){if(e){return}setTimeout(b.Util.bind(function(){this._renderPopup(d.latlng,e,h,g)},this),300)},this);var f=this.identify().at(d.latlng);if(this.options.mosaicRule){f.setMosaicRule(this.options.mosaicRule)}f.run(c);this._shouldRenderPopup=true;this._lastClick=d.latlng},_buildExportParams:function(){var c=this._map.getBounds();var f=this._map.getSize();var d=this._map.options.crs.project(c._northEast);var g=this._map.options.crs.project(c._southWest);var e={bbox:[g.x,g.y,d.x,d.y].join(","),size:f.x+","+f.y,format:this.options.format,transparent:this.options.transparent,bboxSR:this.options.bboxSR,imageSR:this.options.imageSR};if(this.options.from&&this.options.to){e.time=this.options.from.valueOf()+","+this.options.to.valueOf()}if(this.options.pixelType){e.pixelType=this.options.pixelType}if(this.options.interpolation){e.interpolation=this.options.interpolation}if(this.options.compressionQuality){e.compressionQuality=this.options.compressionQuality}if(this.options.bandIds){e.bandIds=this.options.bandIds}if(this.options.noData){e.noData=this.options.noData}if(this.options.noDataInterpretation){e.noDataInterpretation=this.options.noDataInterpretation}if(this._service.options.token){e.token=this._service.options.token}if(this.options.renderingRule){e.renderingRule=JSON.stringify(this.options.renderingRule)}if(this.options.mosaicRule){e.mosaicRule=JSON.stringify(this.options.mosaicRule)}return e},_requestExport:function(d,c){if(this.options.f==="json"){this._service.request("exportImage",d,function(e,f){if(e){return}this._renderImage(f.href,c)},this)}else{d.f="image";this._renderImage(this.options.url+"exportImage"+b.Util.getParamString(d),c)}}});a.ImageMapLayer=a.Layers.ImageMapLayer;a.Layers.imageMapLayer=function(c){return new a.Layers.ImageMapLayer(c)};a.imageMapLayer=function(c){return new a.Layers.ImageMapLayer(c)};a.Layers.TiledMapLayer=b.TileLayer.extend({options:{zoomOffsetAllowance:0.1,correctZoomLevels:true},statics:{MercatorZoomLevels:{"0":156543.033928,"1":78271.51696399989,"2":39135.7584820001,"3":19567.8792409999,"4":9783.939620499959,"5":4891.96981024998,"6":2445.98490512499,"7":1222.99245256249,"8":611.49622628138,"9":305.748113140558,"10":152.874056570411,"11":76.4370282850732,"12":38.2185141425366,"13":19.1092570712683,"14":9.55462853563415,"15":4.77731426794937,"16":2.38865713397468,"17":1.19432856685505,"18":0.597164283559817,"19":0.298582141647617,"20":0.14929107082381,"21":0.07464553541191001,"22":0.0373227677059525,"23":0.0186613838529763}},initialize:function(c){c.url=a.Util.cleanUrl(c.url);c=b.Util.setOptions(this,c);this.tileUrl=b.esri.Util.cleanUrl(c.url)+"tile/{z}/{y}/{x}";this._service=new b.esri.Services.MapService(c);this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",this._propagateEvent,this);if(this.tileUrl.match("://tiles.arcgisonline.com")){this.tileUrl=this.tileUrl.replace("://tiles.arcgisonline.com","://tiles{s}.arcgisonline.com");c.subdomains=["1","2","3","4"]}if(this.options.token){this.tileUrl+=("?token="+this.options.token)}b.TileLayer.prototype.initialize.call(this,this.tileUrl,c)},getTileUrl:function(c){return b.Util.template(this.tileUrl,b.extend({s:this._getSubdomain(c),z:this._lodMap[c.z]||c.z,x:c.x,y:c.y},this.options))},onAdd:function(c){if(!this._lodMap&&this.options.correctZoomLevels){this._lodMap={};this.metadata(function(j,l){if(!j){var m=l.spatialReference.latestWkid||l.spatialReference.wkid;if(m===102100||m===3857){var e=l.tileInfo.lods;var h=a.Layers.TiledMapLayer.MercatorZoomLevels;for(var k=0;k<e.length;k++){var d=e[k];for(var f in h){var g=h[f];if(this._withinPercentage(d.resolution,g,this.options.zoomOffsetAllowance)){this._lodMap[f]=d.level;break}}}}else{a.Util.warn("L.esri.TiledMapLayer is using a non-mercator spatial reference. Support may be available through Proj4Leaflet http://esri.github.io/esri-leaflet/examples/non-mercator-projection.html")}}b.TileLayer.prototype.onAdd.call(this,c)},this)}else{b.TileLayer.prototype.onAdd.call(this,c)}},metadata:function(c,d){this._service.metadata(c,d);return this},identify:function(){return this._service.identify()},authenticate:function(c){var d="?token="+c;this.tileUrl=(this.options.token)?this.tileUrl.replace(/\?token=(.+)/g,d):this.tileUrl+d;this.options.token=c;this._service.authenticate(c);return this},_propagateEvent:function(c){c=b.extend({layer:c.target,target:this},c);this.fire(c.type,c)},_withinPercentage:function(c,d,f){var e=Math.abs((c/d)-1);return e<f}});b.esri.TiledMapLayer=b.esri.Layers.tiledMapLayer;b.esri.Layers.tiledMapLayer=function(c){return new b.esri.Layers.TiledMapLayer(c)};b.esri.tiledMapLayer=function(c){return new b.esri.Layers.TiledMapLayer(c)};a.Layers.FeatureGrid=b.Class.extend({includes:b.Mixin.Events,options:{cellSize:512,updateInterval:150},initialize:function(c){c=b.setOptions(this,c)},onAdd:function(c){this._map=c;this._update=b.Util.limitExecByInterval(this._update,this.options.updateInterval,this);this._map.addEventListener(this.getEvents(),this);this._reset();this._update()},onRemove:function(){this._map.removeEventListener(this.getEvents(),this);this._removeCells()},getEvents:function(){var c={viewreset:this._reset,moveend:this._update,zoomend:this._onZoom};return c},addTo:function(c){c.addLayer(this);return this},removeFrom:function(c){c.removeLayer(this);return this},_onZoom:function(){var c=this._map.getZoom();if(c>this.options.maxZoom||c<this.options.minZoom){this.removeFrom(this._map);this._map.addEventListener("zoomend",this.getEvents().zoomend,this)}else{if(!this._map.hasLayer(this)){this._map.removeEventListener("zoomend",this.getEvents().zoomend,this);this.addTo(this._map)}}},_reset:function(){this._removeCells();this._cells={};this._activeCells={};this._cellsToLoad=0;this._cellsTotal=0;this._resetWrap()},_resetWrap:function(){var e=this._map,d=e.options.crs;if(d.infinite){return}var c=this._getCellSize();if(d.wrapLng){this._wrapLng=[Math.floor(e.project([0,d.wrapLng[0]]).x/c),Math.ceil(e.project([0,d.wrapLng[1]]).x/c)]}if(d.wrapLat){this._wrapLat=[Math.floor(e.project([d.wrapLat[0],0]).y/c),Math.ceil(e.project([d.wrapLat[1],0]).y/c)]}},_getCellSize:function(){return this.options.cellSize},_update:function(){if(!this._map){return}var c=this._map.getPixelBounds(),h=this._map.getZoom(),f=this._getCellSize(),e=[f/2,f/2];if(h>this.options.maxZoom||h<this.options.minZoom){return}var g=c.min.subtract(e).divideBy(f).floor();g.x=Math.max(g.x,0);g.y=Math.max(g.y,0);var d=b.bounds(g,c.max.add(e).divideBy(f).floor());this._removeOtherCells(d);this._addCells(d)},_addCells:function(c){var k=[],e=c.getCenter(),l=this._map.getZoom();var h,g,f;for(h=c.min.y;h<=c.max.y;h++){for(g=c.min.x;g<=c.max.x;g++){f=new b.Point(g,h);f.z=l;k.push(f)}}var d=k.length;if(d===0){return}this._cellsToLoad+=d;this._cellsTotal+=d;k.sort(function(i,j){return i.distanceTo(e)-j.distanceTo(e)});for(g=0;g<d;g++){this._addCell(k[g])}},_cellCoordsToBounds:function(d){var e=this._map,c=this.options.cellSize,g=d.multiplyBy(c),i=g.add([c,c]),f=e.unproject(g,d.z).wrap(),h=e.unproject(i,d.z).wrap();return new b.LatLngBounds(f,h)},_cellCoordsToKey:function(c){return c.x+":"+c.y},_keyToCellCoords:function(d){var c=d.split(":"),e=parseInt(c[0],10),f=parseInt(c[1],10);return new b.Point(e,f)},_removeOtherCells:function(c){for(var d in this._cells){if(!c.contains(this._keyToCellCoords(d))){this._removeCell(d)}}},_removeCell:function(d){var c=this._activeCells[d];if(c){delete this._activeCells[d];if(this.cellLeave){this.cellLeave(c.bounds,c.coords)}this.fire("cellleave",{bounds:c.bounds,coords:c.coords})}},_removeCells:function(){for(var e in this._cells){var c=this._cells[e].bounds;var d=this._cells[e].coords;if(this.cellLeave){this.cellLeave(c,d)}this.fire("cellleave",{bounds:c,coords:d})}},_addCell:function(d){this._wrapCoords(d);var e=this._cellCoordsToKey(d);var c=this._cells[e];if(c&&!this._activeCells[e]){if(this.cellEnter){this.cellEnter(c.bounds,d)}this.fire("cellenter",{bounds:c.bounds,coords:d});this._activeCells[e]=c}if(!c){c={coords:d,bounds:this._cellCoordsToBounds(d)};this._cells[e]=c;this._activeCells[e]=c;if(this.createCell){this.createCell(c.bounds,d)}this.fire("cellcreate",{bounds:c.bounds,coords:d})}},_wrapCoords:function(c){c.x=this._wrapLng?b.Util.wrapNum(c.x,this._wrapLng):c.x;c.y=this._wrapLat?b.Util.wrapNum(c.y,this._wrapLat):c.y}});(function(d){d.Layers.FeatureManager=d.Layers.FeatureGrid.extend({options:{where:"1=1",fields:["*"],from:false,to:false,timeField:false,timeFilterMode:"server",simplifyFactor:0,precision:6},initialize:function(g){d.Layers.FeatureGrid.prototype.initialize.call(this,g);g.url=d.Util.cleanUrl(g.url);g=b.setOptions(this,g);this._service=new d.Services.FeatureLayerService(g);if(this.options.fields[0]!=="*"){var f=false;for(var e=0;e<this.options.fields.length;e++){if(this.options.fields[e].match(/^(OBJECTID|FID|OID|ID)$/i)){f=true}}if(f===false){d.Util.warn("no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.")}}this._service.on("authenticationrequired requeststart requestend requesterror requestsuccess",function(h){h=b.extend({target:this},h);this.fire(h.type,h)},this);if(this.options.timeField.start&&this.options.timeField.end){this._startTimeIndex=new c();this._endTimeIndex=new c()}else{if(this.options.timeField){this._timeIndex=new c()}}this._cache={};this._currentSnapshot=[];this._activeRequests=0;this._pendingRequests=[]},onAdd:function(e){return d.Layers.FeatureGrid.prototype.onAdd.call(this,e)},onRemove:function(e){return d.Layers.FeatureGrid.prototype.onRemove.call(this,e)},getAttribution:function(){return this.options.attribution},createCell:function(e,f){this._requestFeatures(e,f)},_requestFeatures:function(e,g,f){this._activeRequests++;if(this._activeRequests===1){this.fire("loading",{bounds:e})}this._buildQuery(e).run(function(h,i,j){if(j&&j.exceededTransferLimit){this.fire("drawlimitexceeded")}if(!h&&i&&i.features.length){d.Util.requestAnimationFrame(b.Util.bind(function(){this._addFeatures(i.features,g);this._postProcessFeatures(e)},this))}if(!h&&i&&!i.features.length){this._postProcessFeatures(e)}if(f){f.call(this,h,i)}},this)},_postProcessFeatures:function(e){this._activeRequests--;if(this._activeRequests<=0){this.fire("load",{bounds:e})}},_cacheKey:function(e){return e.z+":"+e.x+":"+e.y},_addFeatures:function(f,e){var j=this._cacheKey(e);this._cache[j]=this._cache[j]||[];for(var g=f.length-1;g>=0;g--){var h=f[g].id;this._currentSnapshot.push(h);this._cache[j].push(h)}if(this.options.timeField){this._buildTimeIndexes(f)}var k=this._map.getZoom();if(k>this.options.maxZoom||k<this.options.minZoom){return}this.createLayers(f)},_buildQuery:function(e){var f=this._service.query().intersects(e).where(this.options.where).fields(this.options.fields).precision(this.options.precision);if(this.options.simplifyFactor){f.simplify(this._map,this.options.simplifyFactor)}if(this.options.timeFilterMode==="server"&&this.options.from&&this.options.to){f.between(this.options.from,this.options.to)}return f},setWhere:function(q,f,g){this.options.where=(q&&q.length)?q:"1=1";var n=[];var m=[];var o=0;var l=null;var p=b.Util.bind(function(r,s){o--;if(r){l=r}if(s){for(var t=s.features.length-1;t>=0;t--){m.push(s.features[t].id)}}if(o<=0){this._currentSnapshot=m;d.Util.requestAnimationFrame(b.Util.bind(function(){this.removeLayers(n);this.addLayers(m);if(f){f.call(g,l)}},this))}},this);for(var j=this._currentSnapshot.length-1;j>=0;j--){n.push(this._currentSnapshot[j])}for(var k in this._activeCells){o++;var h=this._keyToCellCoords(k);var e=this._cellCoordsToBounds(h);this._requestFeatures(e,k,p)}return this},getWhere:function(){return this.options.where},getTimeRange:function(){return[this.options.from,this.options.to]},setTimeRange:function(i,p,f,g){var l=this.options.from;var m=this.options.to;var n=0;var k=null;var o=b.Util.bind(function(q){if(q){k=q}this._filterExistingFeatures(l,m,i,p);n--;if(f&&n<=0){f.call(g,k)}},this);this.options.from=i;this.options.to=p;this._filterExistingFeatures(l,m,i,p);if(this.options.timeFilterMode==="server"){for(var j in this._activeCells){n++;var h=this._keyToCellCoords(j);var e=this._cellCoordsToBounds(h);this._requestFeatures(e,j,o)}}},refresh:function(){for(var g in this._activeCells){var f=this._keyToCellCoords(g);var e=this._cellCoordsToBounds(f);this._requestFeatures(e,g)}if(this.redraw){this.once("load",function(){this.eachFeature(function(h){this._redraw(h.feature.id)},this)},this)}},_filterExistingFeatures:function(k,l,h,j){var g=(k&&l)?this._getFeaturesInTimeRange(k,l):this._currentSnapshot;var f=this._getFeaturesInTimeRange(h,j);if(f.indexOf){for(var e=0;e<f.length;e++){var m=g.indexOf(f[e]);if(m>=0){g.splice(m,1)}}}d.Util.requestAnimationFrame(b.Util.bind(function(){this.removeLayers(g);this.addLayers(f)},this))},_getFeaturesInTimeRange:function(k,e){var h=[];var j;if(this.options.timeField.start&&this.options.timeField.end){var l=this._startTimeIndex.between(k,e);var f=this._endTimeIndex.between(k,e);j=l.concat(f)}else{j=this._timeIndex.between(k,e)}for(var g=j.length-1;g>=0;g--){h.push(j[g].id)}return h},_buildTimeIndexes:function(g){var h;var f;if(this.options.timeField.start&&this.options.timeField.end){var j=[];var e=[];for(h=g.length-1;h>=0;h--){f=g[h];j.push({id:f.id,value:new Date(f.properties[this.options.timeField.start])});e.push({id:f.id,value:new Date(f.properties[this.options.timeField.end])})}this._startTimeIndex.bulkAdd(j);this._endTimeIndex.bulkAdd(e)}else{var k=[];for(h=g.length-1;h>=0;h--){f=g[h];k.push({id:f.id,value:new Date(f.properties[this.options.timeField])})}this._timeIndex.bulkAdd(k)}},_featureWithinTimeRange:function(g){if(!this.options.from||!this.options.to){return true}var h=+this.options.from.valueOf();var j=+this.options.to.valueOf();if(typeof this.options.timeField==="string"){var e=+g.properties[this.options.timeField];return(e>=h)&&(e<=j)}if(this.options.timeField.start&&this.options.timeField.end){var i=+g.properties[this.options.timeField.start];var f=+g.properties[this.options.timeField.end];return((i>=h)&&(i<=j))||((f>=h)&&(f<=j))}},authenticate:function(e){this._service.authenticate(e);return this},metadata:function(e,f){this._service.metadata(e,f);return this},query:function(){return this._service.query()},_getMetadata:function(e){if(this._metadata){var f;e(f,this._metadata)}else{this.metadata(b.Util.bind(function(g,h){this._metadata=h;e(g,this._metadata)},this))}},addFeature:function(g,e,f){this._getMetadata(b.Util.bind(function(h,i){this._service.addFeature(g,b.Util.bind(function(j,k){if(!j){g.properties[i.objectIdField]=k.objectId;g.id=k.objectId;this.createLayers([g])}if(e){e.call(f,j,k)}},this))},this))},updateFeature:function(g,e,f){this._service.updateFeature(g,function(h,i){if(!h){this.removeLayers([g.id],true);this.createLayers([g])}if(e){e.call(f,h,i)}},this)},deleteFeature:function(g,e,f){this._service.deleteFeature(g,function(h,i){if(!h&&i.objectId){this.removeLayers([i.objectId],true)}if(e){e.call(f,h,i)}},this)},deleteFeatures:function(g,e,f){return this._service.deleteFeatures(g,function(h,k){if(!h&&k.length>0){for(var j=0;j<k.length;j++){this.removeLayers([k[j].objectId],true)}}if(e){e.call(f,h,k)}},this)}});function c(e){this.values=e||[]}c.prototype._query=function(i){var h=0;var g=this.values.length-1;var f;var e;var j;while(h<=g){j=f=(h+g)/2|0;e=this.values[Math.round(f)];if(+e.value<+i){h=f+1}else{if(+e.value>+i){g=f-1}else{return f}}}return ~g};c.prototype.sort=function(){this.values.sort(function(e,f){return +f.value-+e.value}).reverse();this.dirty=false};c.prototype.between=function(g,e){if(this.dirty){this.sort()}var h=this._query(g);var f=this._query(e);if(h===0&&f===0){return[]}h=Math.abs(h);f=(f<0)?Math.abs(f):f+1;return this.values.slice(h,f)};c.prototype.bulkAdd=function(e){this.dirty=true;this.values=this.values.concat(e)}})(a);a.Layers.FeatureLayer=a.Layers.FeatureManager.extend({statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose"},options:{cacheLayers:true},initialize:function(c){a.Layers.FeatureManager.prototype.initialize.call(this,c);c=b.setOptions(this,c);this._layers={};this._leafletIds={};this._key="c"+(Math.random()*1000000000).toString(36).replace(".","_")},onAdd:function(c){c.on("zoomstart zoomend",function(d){this._zooming=(d.type==="zoomstart")},this);return a.Layers.FeatureManager.prototype.onAdd.call(this,c)},onRemove:function(d){for(var c in this._layers){d.removeLayer(this._layers[c])}return a.Layers.FeatureManager.prototype.onRemove.call(this,d)},createNewLayer:function(c){return b.GeoJSON.geometryToLayer(c,this.options.pointToLayer,b.GeoJSON.coordsToLatLng,this.options)},_updateLayer:function(f,d){var e=[];var c=this.options.coordsToLatLng||b.GeoJSON.coordsToLatLng;if(d.properties){f.feature.properties=d.properties}switch(d.geometry.type){case"Point":e=b.GeoJSON.coordsToLatLng(d.geometry.coordinates);f.setLatLng(e);break;case"LineString":e=b.GeoJSON.coordsToLatLngs(d.geometry.coordinates,0,c);f.setLatLngs(e);break;case"MultiLineString":e=b.GeoJSON.coordsToLatLngs(d.geometry.coordinates,1,c);f.setLatLngs(e);break;case"Polygon":e=b.GeoJSON.coordsToLatLngs(d.geometry.coordinates,1,c);f.setLatLngs(e);break;case"MultiPolygon":e=b.GeoJSON.coordsToLatLngs(d.geometry.coordinates,2,c);f.setLatLngs(e);break}},createLayers:function(c){for(var e=c.length-1;e>=0;e--){var d=c[e];var f=this._layers[d.id];var g;if(f&&!this._map.hasLayer(f)){this._map.addLayer(f)}if(f&&(f.setLatLngs||f.setLatLng)){this._updateLayer(f,d)}if(!f){g=this.createNewLayer(d);g.feature=d;if(this.options.style){g._originalStyle=this.options.style}else{if(g.setStyle){g._originalStyle=g.options}}g._leaflet_id=this._key+"_"+d.id;this._leafletIds[g._leaflet_id]=d.id;g.on(a.Layers.FeatureLayer.EVENTS,this._propagateEvent,this);if(this._popup&&g.bindPopup){g.bindPopup(this._popup(g.feature,g),this._popupOptions)}if(this.options.onEachFeature){this.options.onEachFeature(g.feature,g)}this._layers[g.feature.id]=g;this.resetStyle(g.feature.id);this.fire("createfeature",{feature:g.feature});if(!this.options.timeField||(this.options.timeField&&this._featureWithinTimeRange(d))){this._map.addLayer(g)}}}},addLayers:function(d){for(var c=d.length-1;c>=0;c--){var e=this._layers[d[c]];if(e){this.fire("addfeature",{feature:e.feature});this._map.addLayer(e)}}},removeLayers:function(e,g){for(var c=e.length-1;c>=0;c--){var d=e[c];var f=this._layers[d];if(f){this.fire("removefeature",{feature:f.feature,permanent:g});this._map.removeLayer(f)}if(f&&g){delete this._layers[d]}}},cellEnter:function(c,d){if(!this._zooming){a.Util.requestAnimationFrame(b.Util.bind(function(){var e=this._cacheKey(d);var f=this._cellCoordsToKey(d);var g=this._cache[e];if(this._activeCells[f]&&g){this.addLayers(g)}},this))}},cellLeave:function(c,d){if(!this._zooming){a.Util.requestAnimationFrame(b.Util.bind(function(){var e=this._cacheKey(d);var f=this._cellCoordsToKey(d);var j=this._cache[e];var k=this._map.getBounds();if(!this._activeCells[f]&&j){var l=true;for(var g=0;g<j.length;g++){var h=this._layers[j[g]];if(h&&h.getBounds&&k.intersects(h.getBounds())){l=false}}if(l){this.removeLayers(j,!this.options.cacheLayers)}if(!this.options.cacheLayers&&l){delete this._cache[e];delete this._cells[f];delete this._activeCells[f]}}},this))}},resetStyle:function(c){var d=this._layers[c];if(d){this.setFeatureStyle(d.feature.id,d._originalStyle)}return this},setStyle:function(c){this.options.style=c;this.eachFeature(function(d){this.setFeatureStyle(d.feature.id,c)},this);return this},setFeatureStyle:function(c,e){var d=this._layers[c];if(typeof e==="function"){e=e(d.feature)}if(!e&&!d.defaultOptions){e=b.Path.prototype.options;e.fill=true}if(d&&d.setStyle){d.setStyle(e)}return this},bindPopup:function(c,f){this._popup=c;this._popupOptions=f;for(var d in this._layers){var e=this._layers[d];var g=this._popup(e.feature,e);e.bindPopup(g,f)}return this},unbindPopup:function(){this._popup=false;for(var e in this._layers){var g=this._layers[e];if(g.unbindPopup){g.unbindPopup()}else{if(g.getLayers){var d=g.getLayers();for(var f in d){var c=d[f];c.unbindPopup()}}}}return this},eachFeature:function(d,c){for(var e in this._layers){d.call(c,this._layers[e])}return this},getFeature:function(c){return this._layers[c]},bringToBack:function(){this.eachFeature(function(c){if(c.bringToBack){c.bringToBack()}})},bringToFront:function(){this.eachFeature(function(c){if(c.bringToFront){c.bringToFront()}})},redraw:function(c){if(c){this._redraw(c)}return this},_redraw:function(f){var g=this._layers[f];var c=g.feature;if(g&&g.setIcon&&this.options.pointToLayer){if(this.options.pointToLayer){var d=this.options.pointToLayer(c,b.latLng(c.geometry.coordinates[1],c.geometry.coordinates[0]));var h=d.options.icon;g.setIcon(h)}}if(g&&g.setStyle&&this.options.pointToLayer){var e=this.options.pointToLayer(c,b.latLng(c.geometry.coordinates[1],c.geometry.coordinates[0]));var i=e.options;this.setFeatureStyle(c.id,i)}if(g&&g.setStyle&&this.options.style){this.resetStyle(c.id)}},_propagateEvent:function(c){c.layer=this._layers[this._leafletIds[c.target._leaflet_id]];c.target=this;this.fire(c.type,c)}});a.FeatureLayer=a.Layers.FeatureLayer;a.Layers.featureLayer=function(c){return new a.Layers.FeatureLayer(c)};a.featureLayer=function(c){return new a.Layers.FeatureLayer(c)};a.Controls.Logo=b.Control.extend({options:{position:"bottomright",marginTop:0,marginLeft:0,marginBottom:0,marginRight:0},onAdd:function(){var c=b.DomUtil.create("div","esri-leaflet-logo");c.style.marginTop=this.options.marginTop;c.style.marginLeft=this.options.marginLeft;c.style.marginBottom=this.options.marginBottom;c.style.marginRight=this.options.marginRight;c.innerHTML=this._adjustLogo(this._map._size);this._map.on("resize",function(d){c.innerHTML=this._adjustLogo(d.newSize)},this);return c},_adjustLogo:function(c){if(c.x<=600||c.y<=600){return'<a href="https://developers.arcgis.com" style="border: none;"><img src="https://js.arcgis.com/3.13/esri/images/map/logo-sm.png" alt="Powered by Esri" style="border: none;"></a>'}else{return'<a href="https://developers.arcgis.com" style="border: none;"><img src="https://js.arcgis.com/3.13/esri/images/map/logo-med.png" alt="Powered by Esri" style="border: none;"></a>'}}});a.Controls.logo=function(c){return new b.esri.Controls.Logo(c)};return a}));