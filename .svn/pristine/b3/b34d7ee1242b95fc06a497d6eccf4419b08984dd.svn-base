L.Control.HatTOC=L.Control.extend({options:{position:"topright",autoZIndex:true,title:"Legend:",treeAjaxUrl:null,hashLayers:null,view:null},initialize:function(a,b){L.setOptions(this,b);if(!this.options.treeAjaxUrl){throw"L.Control.HatTOC requires the 'treeAjaxUrl' option to be set."}this._selectedEsriLayerIds=[];this._allLayers=a;this._lastZIndex=0;this._handlingClick=false;this._fullScreen=false;this._allLayers.eachLayer(function(c){if(this.options.autoZIndex&&c.setZIndex){this._lastZIndex++;c.setZIndex(this._lastZIndex)}},this)},getSelectedEsriLayerIds:function(){return this._selectedEsriLayerIds},onAdd:function(a){this._initLayout();a.on("fullscreenchange",this._ChangeHeightToFitMap,this);a.on("resize",this._ChangeHeightToFitMap,this);a.on("zoomstart",this._UpdateOnZoom,this);this._ChangeHeightToFitMap();return this._container},onRemove:function(a){a.off("fullscreenchange",this._ChangeHeightToFitMap,this)},_initLayout:function(){var d="leaflet-control-toc",e=this._container=L.DomUtil.create("div",d+"  leaflet-control-layers");L.DomEvent.disableClickPropagation(e);L.DomEvent.disableScrollPropagation(e);e.setAttribute("aria-haspopup",true);e.setAttribute("style","width: "+this.options.width);var h=L.DomUtil.create("div",d+"-title");h.innerHTML=this.options.title;e.appendChild(h);var i=L.DomUtil.create("div",d+"-tree");var b=L.DomUtil.create("div","aciTree");b.id="acitree-hattoc";b.innerHTML='<center id="HatTocInitialLoadingSpinner"><img src="'+this.options.spinnerImageUrl+'"></center>';i.appendChild(b);e.appendChild(i);var j=this.options.treeAjaxUrl;var f="";if(location.hash.split("/")[3]){f=location.hash.split("/")[3]}if(f!=null){j=j+"?hashLayers="+f}var c={ajax:{url:j},checkbox:true,radio:true,unique:false,multiSelectable:true,checkboxChain:false,radioChain:false,radioBreak:false,};var a=this._aciTree=$(b).aciTree(c);a.HatTOC=this;var g=this;$(i).on("acitree",$.proxy(this._aciTreeEvent,this))},_aciAreAnyRadiosAtTheSameLevelChecked:function(a,f,b){for(var d=0;d<b.length;d++){var c=a.itemFrom(b[d]);var e=a.level(c);if(e==f&&a.hasRadio(c)&&a.isChecked(c)){return true}}return false},_aciTreeEvent:function(g,b,l,h,o){if(h=="loaded"||h=="loadfail"){$("#HatTocInitialLoadingSpinner").hide()}if(h=="checked"&&!this._handlingClick){this._handlingClick=true;var q=b.path(l,false);for(var k=0;k<q.length;k++){var p=b.itemFrom(q[k]);if(!b.isChecked(p)){b.check(p)}}var c=b.children(l,true,true);for(var k=0;k<c.length;k++){var f=b.itemFrom(c[k]);var n=b.level(f);if(b.hasRadio(f)&&!this._aciAreAnyRadiosAtTheSameLevelChecked(b,n,c)){b.check(f)}else{if(b.hasCheckbox(f)&&!b.isChecked(f)){b.check(f)}}}if(b.hasRadio(l)){var s=b.siblings(l,true);for(var k=0;k<s.length;k++){var r=b.itemFrom(s[k]);if(b.hasRadio(r)&&b.isChecked(r)){b.uncheck(r)}}}this._handlingClick=false}if(h=="unchecked"&&!this._handlingClick){if(b.hasCheckbox(l)){this._handlingClick=true;var q=b.path(l,true);for(var k=0;k<q.length;k++){var p=b.itemFrom(q[k]);if(b.hasCheckbox(p)||b.hasRadio(p)){var e=b.children(p,false,true);if(e==null||e.length==0){b.uncheck(p)}else{var a=true;for(var m=0;m<e.length;m++){var d=b.itemFrom(e[m]);if(b.hasCheckbox(d)&&b.isChecked(d)){a=false;break}}if(a){b.uncheck(p)}else{break}}}}this._handlingClick=false}}if(h=="checked"||h=="unchecked"){this._updateMapLayerDisplay(b);window.map.fire("update-layer-hash")}else{if(h=="loaded"){this._acitree_allData_loaded(g,b,l,h,o)}}},_acitree_allData_loaded:function(b,a,d,c,e){this._ChangeHeightToFitMap();this._updateMapLayerDisplay(a);window.map.fire("tree-data-loaded")},_areItemAndAllParentsChecked:function(a,c,d){if(d._isGroupNode){return false}if(!a.isChecked(c)){return false}var f=a.path(c,false);for(var b=0;b<f.length;b++){var e=a.itemFrom(f[b]);if(!a.isChecked(e)){return false}}return true},_updateMapLayerDisplay:function(a){if(!this._container){return}if(!a){throw"Error: the _updateMapLayerDisplay needs to be passed an aciTree api object!"}var l={};var n=$(".aciTreeLi",this._container);var c=a.enabled(n);for(var e=0;e<c.length;e++){var m=c[e];var f=a.itemFrom(m);var g=a.itemData(f);if(this._areItemAndAllParentsChecked(a,f,g)){if(g._esrilayerid!=null&&typeof g._esrilayerid!="undefined"){var k=g._maplayerindex;var d=g._esrilayerid;if(l[k]==null){l[k]=[]}l[k].push(d)}else{if(g._maplayerindex!=null&&typeof g._maplayerindex!="undefined"){var k=g._maplayerindex;l[k]=[]}}}}this._selectedEsriLayerIds=l;var j=0;for(var h in this._allLayers._layers){if(typeof this._allLayers._layers[h].setLayers!="undefined"){var b=l[j];if(b==null){b=[-1]}this._allLayers._layers[h].setLayers(b)}else{if(l[j]){this._map.addLayer(this._allLayers._layers[h])}else{this._map.removeLayer(this._allLayers._layers[h])}}j++}},setLayersCheckedByLayerIds:function(g){var a=$(".aciTree").aciTree("api");var j=$(".aciTreeLi",this._container);var b=a.checkboxes(j,true);for(var c=0;c<b.length;c++){var h=b[c];var d=a.itemFrom(h);a.uncheck(d)}var k=a.checkboxes(j);for(var c=0;c<k.length;c++){var h=k[c];var d=a.itemFrom(h);var e=a.itemData(d);var f=e._maplayerindex;g.forEach(function(l){var i=parseInt(l);if(i==f){a.check(d)}})}},getTreeNodeByEsriLayerId:function(k,c){if(!this._aciTree){return null}var l=null;var a=$("#acitree-hattoc").aciTree("api");var n=$(".aciTreeLi",this._container);var b=a.enabled(n);var h=0;for(var g in this._allLayers._layers){if(k._leaflet_id==g){var j="node"+h+"-"+c;for(var d=0;d<b.length;d++){var m=b[d];var e=a.itemFrom(m);var f=a.getId(e);if(f==j){return{item:e,itemData:a.itemData(e),api:a}}}}h++}return l},_ChangeHeightToFitMap:function(){return;var a=$(this._map._container).height()-100-$(this._container).position().top;$(this._container).height(a);var b=$(".leaflet-control-toc-title").height();var c=a-b;$(".leaflet-control-toc-tree").height(c)},_UpdateOnZoom:function(f){if(!this._map){return}var d=96*39.37007874016;var l=this._map.getZoom();var a=this._map.getBounds(),b=a.getCenter().lat,g=6378137*Math.PI*Math.cos(b*Math.PI/180),c=g*(a.getNorthEast().lng-a.getSouthWest().lng)/180,k=this._map.getSize(),i=this.options,h=0;if(k.x>0){var j=(c/k.x)*d;console.log("zoom level="+l+"; scaleDenom:"+j)}}});L.control.hattoc=function(a,c,b){return new L.Control.HatTOC(a,c,b)};