@{
    Hatfield.WebMap.Domain.WebMappingSite site = ViewBag.site;
    string currentViewName = ViewBag.currentViewName.ToString();
}
    <script>
    /* _YMMFire_HeaderScriptsAreaControl */
    /* Global page variables */
    var numLayersLoading = 0;
    var map = null;
    var identifiedFeature = null;
    var allLayers = null; // L.layerGroup();
    var queryTemplates = {};


    function startLayerLoading()
    {
        $('.map-loading-icon').removeClass('hidden');
        $('.map-loading-icon').show();
        numLayersLoading++;
    }

    function endLayerLoading()
    {
        numLayersLoading--;
        if (numLayersLoading <= 0)
        {
            numLayersLoading = 0;
            $('.map-loading-icon').hide();
        }
    }


    function zoomToIdentifiedFeature()
    {
        map.fitBounds(identifiedFeature.getBounds());
    }


    $(document).ready(function () {


        // handling zoom level dependent layers: https://github.com/Leaflet/Leaflet/issues/823
        // handling zoom level dependent layers: http://wiki.openstreetmap.org/wiki/Zoom_levels

        map = L.map('map', { attributionControl: false, fullscreenControl: true }).setView([@site.InitialMapCenter.Latitude, @site.InitialMapCenter.Longitude], @site.InitialMapZoomLevel);

        L.control.scale({ imperial: false }).addTo(map);

        allLayers = L.layerGroup();

        L.layerCatalogue = {};

        @{

            //var layerCatalogue = site.layerCatalogue;
            //@Html.Raw("L.layerCatalogue.list = " + layerCatalogue + ";\n");

            var layers = site.Layers;
            for (var i = 0; i < layers.Count(); i++ )
            {
                string layerName = "layer_" + (i).ToString();

                var layer = layers.ElementAt(i);
                string jsCreate = layer.getJavascriptCreateStatement(layerName, site);
                @Html.Raw(jsCreate);
                @Html.Raw(Environment.NewLine);

                if (layer.RequiresAuthentication)
                {
                    @Html.Raw(layerName + ".authenticate('" + ViewBag.token + "');" + Environment.NewLine);
                }
                @Html.Raw("allLayers.addLayer(" + layerName + ");" + Environment.NewLine);
                if(layer.InitiallyVisible)
                {
                    @Html.Raw(layerName + ".addTo(map);" + Environment.NewLine);
                }

                if (layer.Queryable)
                {
                    @Html.Raw(layerName+".on('requestend', function () { $('.feature-query-loading-icon').hide(); });"+Environment.NewLine);
                    @Html.Raw(layerName+".on('requeststart', function () { $('.feature-query-loading-icon').removeClass('hidden').show(); });"+Environment.NewLine);

                }
                @Html.Raw(layerName + ".on('load', endLayerLoading);" + Environment.NewLine);
                @Html.Raw(layerName + ".on('loading', startLayerLoading);" + Environment.NewLine);

                @Html.Raw(layerName + ".hashName = '" + (i).ToString() + "';" + Environment.NewLine);
            }
        }

        /*
        if (L.PanelManager && L.Redliner) {
            var redliner = L.Redliner.addTo(map);
            var redlinerNetworking = L.RedlinerNetworking.addTo(map);
            var panelManager = L.PanelManager.addTo(map);
            map.PanelManager.loadPlugin(map.Redliner);
        }
        */

        var redliner = L.Redliner.addTo(map);

        var hashLayers;
        var view;

        if (location.pathname.split('/')[3]) {
            view = location.pathname.split('/')[3];
        }

        if (location.hash.split('/')[3]) {
            hashLayers = location.hash.split('/')[3];
        }

        var layerPicker = L.control.hattoc(allLayers, {
            spinnerImageUrl: '@Url.Content("~/js/jquery-aciTree-4.5.0-rc.10/image/load-root.gif")',
            // @Url.Action("GetACITreeTOCJsonData", "Home", new { v = currentViewName })
            treeAjaxUrl: '@Url.Action("GetACITreeTOCJsonData", "Home", new { v = currentViewName })',
            // treeAjaxUrl: '@Url.Action("GetACITreeTOCJsonData")',
            hashLayers: hashLayers,
            view: view
        }); //.addTo(map)
    map._HatTOC = layerPicker;

    map.on("popupclose", function () {
        if (identifiedFeature) {
            map.removeLayer(identifiedFeature);
        }
    }); // popuponclose

    /* create and attach leaflet-sidebar */
    var sidebar = L.control.sidebar('sidebar', {
        closeButton: false,
        position: 'right'
    });
    map.addControl(sidebar);

    sidebar.show();
    sidebar.addContent(layerPicker, 'layerPicker');

    if (L.Hash) {
        var hash = new L.Hash(map);
        hash.update();
    }

    }); // document.ready
</script>

