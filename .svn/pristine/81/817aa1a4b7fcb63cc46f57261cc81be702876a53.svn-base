@{
    Hatfield.WebMap.Domain.WebMappingSite site = ViewBag.site;
    string currentViewName = ViewBag.currentViewName.ToString();
}
<script>
    /* _Default_MapScriptsAreaControl */
    /* Global page variables */
    var numLayersLoading = 0;
    var map = null;
    var allLayers = null; // L.layerGroup();
    var queryTemplates = {};


    function startLayerLoading()
    {
        $('.map-loading-icon').removeClass('hidden');
        $('.map-loading-icon').show();
        numLayersLoading++;
    }

    function endLayerLoading()
    {
        numLayersLoading--;
        if (numLayersLoading <= 0)
        {
            numLayersLoading = 0;
            $('.map-loading-icon').hide();
        }
    }


    $(document).ready(function () {

        map = L.map('map', { attributionControl: false, fullscreenControl: true }).setView([@site.InitialMapCenter.Latitude, @site.InitialMapCenter.Longitude], @site.InitialMapZoomLevel);

        L.control.scale({ imperial: false }).addTo(map);

        allLayers = L.layerGroup();

        @{
            

            var layers = site.Layers;
            for (var i = 0; i < layers.Count(); i++ )
            {
                string layerName = "layer_" + (i).ToString();

                var layer = layers.ElementAt(i);
                string jsCreate = layer.getJavascriptCreateStatement(layerName, site);
                @Html.Raw(jsCreate);
                @Html.Raw(Environment.NewLine);

                if (layer.RequiresAuthentication)
                {
                    @Html.Raw(layerName + ".authenticate('" + ViewBag.token + "');" + Environment.NewLine);
                }
                @Html.Raw("allLayers.addLayer(" + layerName + ");" + Environment.NewLine);
                if(layer.InitiallyVisible)
                {
                    @Html.Raw(layerName + ".addTo(map);" + Environment.NewLine);
                }

                if (layer.Queryable)
                {
                    @Html.Raw(layerName+".on('requestend', function () { $('.feature-query-loading-icon').hide(); });"+Environment.NewLine);
                    @Html.Raw(layerName+".on('requeststart', function () { $('.feature-query-loading-icon').removeClass('hidden').show(); });"+Environment.NewLine);

                }
                @Html.Raw(layerName + ".on('load', endLayerLoading);" + Environment.NewLine);
                @Html.Raw(layerName + ".on('loading', startLayerLoading);" + Environment.NewLine);

                @Html.Raw(layerName + ".hashName = '" + (i).ToString() + "';" + Environment.NewLine);
            }
            
            string viewParam = "";
            if (!string.IsNullOrEmpty(currentViewName))
            {
                viewParam = currentViewName;
            }
        }


        if (L.Control.HatTOC)
        {
            var layerPicker = L.control.hattoc(allLayers, {
                spinnerImageUrl: '@Url.Content("~/js/jquery-aciTree-4.5.0-rc.10/image/load-root.gif")',
                treeAjaxUrl: '@Url.Action("GetACITreeTOCJsonData", "Home", new { v = currentViewName })',
                view: '@Html.Raw(viewParam)'
            }).addTo(map)
            map._HatTOC = layerPicker;
            
        }

        if (L.Hash) {
            var hash = new L.Hash(map);
            hash.update();
        }

    }); // document.ready
</script>

